
/*
 * LEARNINGS
 * TO MAKE A BIT ZERO  ------> &= ~(0x3 << (5*2));
 *
 */
#include "stm32f446rxx.h"
#include <stdint.h>
#include <stdio.h>

// ========= Function prototypes =========
void ADC1_Init(void);
uint32_t ADC1_Read(void);
float LM35_ReadTemp(void);
void SWV_Print(char *msg);

// ======================================
int main(void)
{
    GPIOA_CLK_EN();     // Enable GPIOA clock
    ADC1_CLK_EN();      // Enable ADC1 clock

    // PA1 as ANALOG
    GPIOA->MODER &= ~(0x3 << (1*2));
    GPIOA->MODER |=  (0x3 << (1*2));   // 11 = Analog mode

    ADC1_Init();        // Configure ADC1

    while(1)
    {
        float temp = LM35_ReadTemp();

        char msg[50];
        sprintf(msg, "Temperature : %.2f C\n", temp);
        SWV_Print(msg);

        for(int i = 0 ; i < 100000; i++); // small delay
    }
}

// ================= ADC INITIALIZATION =================
void ADC1_Init(void)
{
    ADC1->CR2 = 0;

    ADC1->SQR3 = 1;           // Channel 1
    ADC1->SMPR2 |= (7 << 3);  // 480 cycles sample time

    ADC1->CR2 |= (1 << 0);    // ADON enable
}

// ================= ADC READ ===========================
uint32_t ADC1_Read(void)
{
    ADC1->CR2 |= (1 << 30);          // SWSTART
    while(!(ADC1->SR & (1 << 1)));   // Wait for EOC
    return ADC1->DR;                 // Return data
}

// ================= LM35 Temp ==========================
float LM35_ReadTemp(void)
{
    uint32_t adc = ADC1_Read();
    float voltage_mv = (adc * 3300.0f) / 4095.0f;
    return voltage_mv / 10.0f; // LM35 = 10mV per 1Â°C
}

// ================= SWV PRINT ==========================
void SWV_Print(char *msg)
{
    while(*msg)
    {
        ITM_SendChar(*msg++);
    }
}
